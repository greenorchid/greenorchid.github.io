name: Bluesky Auto-Post

on:
  push:
    branches:
      - 'main' # Run on main branch only
    paths:
      - 'src/lib/blog/posts/*.md'
      - 'src/lib/recipes/posts/*.md'

permissions:
  contents: write # Required to commit changes back
  pull-requests: write # Required to create pull requests for bluesky metadata

jobs:
  bluesky-post:
    runs-on: ubuntu-latest
    # Only run after successful build (if build job exists in deploy.yml)
    # Remove this condition if you want it to run independently
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need at least 2 commits to compare
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install @atproto/api gray-matter glob

      - name: Post to Bluesky
        id: bluesky-post
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
          SITE_URL: https://behan.dev
        run: |
          node .github/scripts/bluesky-post.js

      - name: Create Pull Request for Bluesky metadata
        # A no-op PR is created if the script updated any files, but will skip step if no changes
        if: ${{ steps.bluesky-post.outputs.UPDATED_FILES && steps.bluesky-post.outputs.UPDATED_FILES != '0' }}
        uses: peter-evans/create-pull-request@v6
        with:
          branch: automation/bluesky-metadata
          delete-branch: true
          title: 'chore: add Bluesky URIs to new posts'
          commit-message: 'chore: add Bluesky URIs to new posts [skip ci]'
          body: |
            This PR was automatically generated by the Bluesky Auto-Post workflow.

            It adds Bluesky post URIs to newly published blog or recipe posts.
          add-paths: |
            src/lib/blog/posts/*.md
            src/lib/recipes/posts/*.md
